{% extends 'base.html' %}

{% block title %}Editar Evento - EventosPSW{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="mb-0"><i class="bi bi-pencil me-2"></i>Editar Evento: {{ evento.nome }}</h3>
                    </div>
                    <div class="card-body p-4">
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <h6 class="alert-heading">Corrija os erros abaixo:</h6>
                                <ul class="mb-0">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="{{ form.nome.id_for_label }}" class="form-label">Nome do Evento *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                                        {{ form.nome }}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.tipo.id_for_label }}" class="form-label">Tipo *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                        {{ form.tipo }}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.descricao.id_for_label }}" class="form-label">Descrição *</label>
                                {{ form.descricao }}
                                <div class="form-text">Descreva detalhadamente o que os participantes podem esperar do evento.</div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.data.id_for_label }}" class="form-label">Data *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                        {{ form.data }}
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.horario.id_for_label }}" class="form-label">Horário *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                        {{ form.horario }}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.local.id_for_label }}" class="form-label">Local *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    {{ form.local }}
                                </div>
                                <div class="form-text">Selecione o local onde o evento será realizado.</div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.capacidade.id_for_label }}" class="form-label">Capacidade *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-people"></i></span>
                                        {{ form.capacidade }}
                                        <span class="input-group-text">pessoas</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.preco.id_for_label }}" class="form-label">Preço</label>
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        {{ form.preco }}
                                    </div>
                                    <div class="form-text">Deixe em branco para evento gratuito.</div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">Status *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-info-circle"></i></span>
                                        {{ form.status }}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.imagem.id_for_label }}" class="form-label">Imagem do Evento</label>
                                {% if evento.imagem %}
                                    <div class="mb-2">
                                        <img src="{{ evento.imagem.url }}" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                                        <p class="small text-muted mt-1">Imagem atual</p>
                                    </div>
                                {% endif %}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-image"></i></span>
                                    {{ form.imagem }}
                                </div>
                                <div class="form-text">Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 5MB. Deixe em branco para manter a imagem atual.</div>
                            </div>

                            <!-- Seção de palestrantes removida -->

                            <!-- Informações adicionais sobre inscrições -->
                            {% if evento.inscricoes.count > 0 %}
                                <div class="alert alert-info">
                                    <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Informações sobre Inscrições</h6>
                                    <p class="mb-1">Este evento possui <strong>{{ evento.inscricoes.count }}</strong> inscrição(ões) confirmada(s).</p>
                                    <p class="mb-0">Tenha cuidado ao alterar dados como capacidade, data ou local, pois isso pode afetar os participantes já inscritos.</p>
                                </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-4">
                                    <a href="{% url 'detalhe_evento' evento.id %}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left me-2"></i>Voltar
                                    </a>
                                </div>
                                <div class="col-md-4 text-center">
                                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                        <i class="bi bi-trash me-2"></i>Excluir Evento
                                    </button>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="submit" class="btn btn-warning btn-lg">
                                        <i class="bi bi-save me-2"></i>Salvar Alterações
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação de exclusão -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o evento <strong>"{{ evento.nome }}"</strong>?</p>
                    {% if evento.inscricoes.count > 0 %}
                        <div class="alert alert-warning">
                            <strong>Atenção:</strong> Este evento possui {{ evento.inscricoes.count }} inscrição(ões). 
                            Ao excluir o evento, todas as inscrições também serão removidas.
                        </div>
                    {% endif %}
                    <p class="text-muted">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x me-2"></i>Cancelar
                    </button>
                    <form method="post" action="{% url 'eventos:deletar_evento' evento.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-2"></i>Excluir Definitivamente
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Add Bootstrap classes to form fields
    document.addEventListener('DOMContentLoaded', function() {
        // Text inputs
        const textInputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="date"], input[type="time"], input[type="file"]');
        textInputs.forEach(input => {
            input.classList.add('form-control');
        });

        // Select fields
        const selectFields = document.querySelectorAll('select');
        selectFields.forEach(select => {
            select.classList.add('form-select');
        });

        // Textarea
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.classList.add('form-control');
            textarea.rows = 4;
        });

        // Price input formatting
        const priceInput = document.querySelector('input[name="preco"]');
        if (priceInput) {
            priceInput.addEventListener('input', function() {
                let value = this.value.replace(/[^\d.,]/g, '');
                this.value = value;
            });
        }

        // Capacity validation
        const capacityInput = document.querySelector('input[name="capacidade"]');
        if (capacityInput) {
            capacityInput.addEventListener('input', function() {
                if (this.value < 1) {
                    this.value = 1;
                }
            });
        }

        // Image preview for new uploads
        const imageInput = document.querySelector('input[type="file"]');
        if (imageInput) {
            imageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    // Check file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Arquivo muito grande. O tamanho máximo é 5MB.');
                        this.value = '';
                        return;
                    }

                    // Check file type
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('Formato não suportado. Use JPG, PNG ou GIF.');
                        this.value = '';
                        return;
                    }

                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let preview = document.getElementById('new-image-preview');
                        if (!preview) {
                            preview = document.createElement('div');
                            preview.id = 'new-image-preview';
                            preview.className = 'mt-2';
                            imageInput.parentElement.parentElement.appendChild(preview);
                        }
                        preview.innerHTML = `
                            <p class="small text-success">Nova imagem:</p>
                            <img src="${e.target.result}" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                            <p class="small text-muted mt-1">${file.name}</p>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Form validation
        const form = document.querySelector('form');
        if (form && !form.action.includes('deletar')) {
            form.addEventListener('submit', function(e) {
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert('Por favor, preencha todos os campos obrigatórios.');
                }
            });
        }
    });
</script>
{% endblock %}